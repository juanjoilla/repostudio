<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Planes - Artes Luis Studio</title>

  <!-- Bootstrap 5.3 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Estilos personalizados -->
  <link rel="stylesheet" th:href="@{/css/styles.css}" />
</head>
<body>
  <!-- Navegación -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container">
      <a class="navbar-brand" th:href="@{/}">Artes Luis Studio</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" th:href="@{/}">Inicio</a></li>
          <li class="nav-item"><a class="nav-link" th:href="@{/nosotros}">Nosotros</a></li>
          <li class="nav-item"><a class="nav-link" th:href="@{/mision}">Misión</a></li>
          <li class="nav-item"><a class="nav-link active" th:href="@{/planes}">Planes</a></li>
          <li class="nav-item"><a class="nav-link" th:href="@{/portafolio}">Portafolio</a></li>
          <li class="nav-item"><a class="nav-link" th:href="@{/contacto}">Contacto</a></li>
          <li class="nav-item"><a class="nav-link" th:href="@{/login}">Login</a></li>
          <li class="nav-item" th:if="${usuarioLogueado}">
            <a class="nav-link" th:href="@{/planes/carrito}">
              <i class="fas fa-shopping-cart"></i> 
              <span class="badge bg-danger" th:text="${itemsEnCarrito}" th:if="${itemsEnCarrito > 0}">0</span>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Contenido principal -->
  <main class="container mt-5 pt-5">
    <div class="row">
      <div class="col-12">
        <h1 class="text-center mb-5">Nuestros Planes</h1>
        <div class="row">
          <div class="col-md-4 mb-4" th:each="plan : ${planes}">
            <div class="card h-100" th:classappend="${plan.esRecomendado ? 'border-warning' : ''}">
              <div class="card-header text-white text-center" 
                   th:classappend="'bg-' + ${plan.colorBadge}">
                <h4 th:text="${plan.nombre}">Plan Name</h4>
                <h2>$<span th:text="${plan.precio}">99</span></h2>
                <p>por proyecto</p>
                <span class="badge bg-danger" th:if="${plan.esRecomendado}">Recomendado</span>
              </div>
              <div class="card-body">
                <p class="mb-3" th:text="${plan.descripcion}">Description</p>
                <ul class="list-unstyled">
                  <li th:each="caracteristica : ${plan.caracteristicasAsList}">
                    <i class="fas fa-check text-success"></i> 
                    <span th:text="${caracteristica}">Feature</span>
                  </li>
                </ul>
                <div class="mt-3" th:if="${plan.numeroRevisiones == -1}">
                  <small class="text-muted">Revisiones ilimitadas</small>
                </div>
                <div class="mt-3" th:unless="${plan.numeroRevisiones == -1}">
                  <small class="text-muted" th:text="${plan.numeroRevisiones + ' revisiones incluidas'}">Revisiones</small>
                </div>
              </div>
              <div class="card-footer">
                <button class="btn btn-block w-100 agregar-carrito-btn" 
                        th:classappend="'btn-' + ${plan.colorBadge}"
                        th:data-plan-id="${plan.id}"
                        th:data-plan-nombre="${plan.nombre}">
                  Elegir Plan
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Pie de página -->
  <footer class="footer-nosotros mt-5">
    <div class="footer-center">
      <p class="mb-0">&copy; 2026 Artes Luis Studio. Todos los derechos reservados</p>
    </div>
  </footer>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Font Awesome -->
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <script th:src="@{/js/artesluis.js}"></script>
  
  <!-- Script específico para carrito -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Verificar si el usuario está logueado
      const usuarioLogueado = /*[[${usuarioLogueado}]]*/ false;
      
      // Agregar event listeners a todos los botones de "Elegir Plan"
      document.querySelectorAll('.agregar-carrito-btn').forEach(function(button) {
        button.addEventListener('click', function() {
          // Verificar autenticación primero
          if (!usuarioLogueado) {
            showAlert('warning', 'Debes iniciar sesión para agregar planes al carrito');
            setTimeout(() => {
              window.location.href = '/login';
            }, 2000);
            return;
          }
          
          const planId = this.getAttribute('data-plan-id');
          const planNombre = this.getAttribute('data-plan-nombre');
          
          console.log('Plan ID:', planId); // Debug
          console.log('Plan Nombre:', planNombre); // Debug
          
          // Deshabilitar el botón mientras se procesa
          button.disabled = true;
          const originalText = button.innerHTML;
          button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Agregando...';
          
          // Enviar request para agregar al carrito
          fetch('/planes/agregar-carrito', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `planId=${planId}&cantidad=1`
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // Actualizar contador del carrito
              const badge = document.querySelector('.badge');
              if (badge) {
                badge.textContent = data.itemsEnCarrito;
                badge.style.display = data.itemsEnCarrito > 0 ? 'inline' : 'none';
              } else if (data.itemsEnCarrito > 0) {
                // Crear badge si no existe
                const carritoLink = document.querySelector('a[href="/planes/carrito"]');
                if (carritoLink) {
                  const newBadge = document.createElement('span');
                  newBadge.className = 'badge bg-danger';
                  newBadge.textContent = data.itemsEnCarrito;
                  carritoLink.appendChild(newBadge);
                }
              }
              
              // Mostrar mensaje de éxito
              showAlert('success', `${planNombre} agregado al carrito exitosamente`);
              
            } else {
              if (data.requireLogin) {
                showAlert('warning', data.message);
                setTimeout(() => {
                  window.location.href = '/login';
                }, 2000);
              } else {
                showAlert('error', data.message);
              }
            }
          })
          .catch(error => {
            console.error('Error:', error);
            showAlert('error', 'Error al agregar el plan al carrito');
          })
          .finally(() => {
            // Restaurar botón
            button.innerHTML = originalText;
            button.disabled = false;
          });
        });
      });
    });
    
    function showAlert(type, message) {
      // Crear el alert
      const alertDiv = document.createElement('div');
      let alertClass = 'alert-info';
      if (type === 'success') alertClass = 'alert-success';
      else if (type === 'error') alertClass = 'alert-danger';
      else if (type === 'warning') alertClass = 'alert-warning';
      
      alertDiv.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
      alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
      alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      
      // Agregar al body
      document.body.appendChild(alertDiv);
      
      // Remover automáticamente después de 5 segundos
      setTimeout(() => {
        if (alertDiv.parentNode) {
          alertDiv.parentNode.removeChild(alertDiv);
        }
      }, 5000);
    }
  </script>
</body>
</html>